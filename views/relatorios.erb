<div class="dashboard-main">
  <div id="flash-messages-container">
    <% if @sucesso %>
      <div class="flash-message success mt-3"><%= h(@sucesso) %></div>
    <% end %>
    <% if @erro %>
      <div class="flash-message error mt-3"><%= h(@erro) %></div>
    <% end %>
    <% if @info %>
      <div class="flash-message info mt-3"><%= h(@info) %></div>
    <% end %>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h2>Relatório de Estoque</h2>
    </div>
    <div class="card-body">
      <h3>Filtros de Relatório</h3>
      <form action="/relatorios" method="get">
        <div class="row align-items-end mb-3">
          <div class="col-md-6 mb-3">
            <label for="codigo" class="form-label">Código:</label>
            <input type="text" id="codigo" name="codigo" class="form-control" value="<%= h(params[:codigo]) %>" placeholder="Buscar por código...">
          </div>
          <div class="col-md-6 mb-3">
            <label for="categoria" class="form-label">Categoria:</label>
            <select id="categoria" name="categoria" class="form-control">
              <% @categorias_disponiveis.each do |cat| %>
                <option value="<%= h(cat) %>" <%= 'selected' if params[:categoria] == cat %>><%= h(cat) %></option>
              <% end %>
              <% if @categorias_disponiveis.empty? || !@categorias_disponiveis.include?("Todas") %>
                <option value="Todas" <%= 'selected' if params[:categoria] == "Todas" %> >Todas</option>
              <% end %>
            </select>
          </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-primary btn-filter mb-4 mb-5">Aplicar Filtros</button>
          <a href="/relatorios" class="btn btn-secondary btn-filter mb-4">Limpar Filtros</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3>Total de Produtos: <%= @produtos_filtrados.count %></h3>
    </div>
    <div class="card-body">
      <% if @produtos_filtrados.empty? %>
        <p class="text-center">Nenhum produto encontrado com os filtros aplicados.</p>
      <% else %>
        <div class="table-wrapper">
          <table>
            <thead>
            <tr>
              <th>Nome</th>
              <th>Código</th>
              <th>Categoria</th>
              <th>Qtd.</th>
              <th>Preço Unit.</th>
              <th>Valor Total</th>
            </tr>
            </thead>
            <tbody>
            <% @produtos_filtrados.each do |produto| %>
              <tr>
                <td><%= h(produto['nome']) %></td>
                <td><%= h(produto['codigo']) %></td>
                <td><%= h(produto['categoria']) %></td>
                <td><%= h(produto['quantidade']) %></td>
                <td>R$ <%= '%.2f' % produto['preco'] %></td>
                <td>R$ <%= '%.2f' % (produto['quantidade'] * produto['preco']) %></td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
</div>